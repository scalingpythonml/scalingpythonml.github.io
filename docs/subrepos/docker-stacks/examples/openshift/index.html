<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Scaling Python ML | Blog of my adventures working with different tools for scaling Python ML workloads.</title>
<meta name="generator" content="Jekyll v3.9.0" />
<meta property="og:title" content="Scaling Python ML" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Blog of my adventures working with different tools for scaling Python ML workloads." />
<meta property="og:description" content="Blog of my adventures working with different tools for scaling Python ML workloads." />
<meta property="og:site_name" content="Scaling Python ML" />
<script type="application/ld+json">
{"url":"/subrepos/docker-stacks/examples/openshift/","description":"Blog of my adventures working with different tools for scaling Python ML workloads.","headline":"Scaling Python ML","@type":"WebPage","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link href="https://unpkg.com/@primer/css/dist/primer.css" rel="stylesheet" />
  <link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="/feed.xml" title="Scaling Python ML" />

  <script>
  function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
  }
  window.onload = wrap_img;
  </script>

</head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Scaling Python ML</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about.html">About</a><a class="page-link" href="/mailinglist.html">Mailinglist</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post">

  <header class="post-header">
    <h1 class="post-title"></h1>
  </header>

  <div class="post-content">
    <p>This example provides templates for deploying the Jupyter Project docker-stacks images to OpenShift.</p>

<h2 id="prerequsites">Prerequsites</h2>

<p>Any OpenShift 3 environment. The templates were tested with OpenShift 3.7. It is believed they should work with at least OpenShift 3.6 or later.</p>

<p>Do be aware that the Jupyter Project docker-stacks images are very large. The OpenShift environment you are using must provide sufficient quota on the per user space for images and the file system for running containers. If the quota is too small, the pulling of the images to a node in the OpenShift cluster when deploying them, will fail due to lack of space. Even if the image is able to be run, if the quota is only just larger than the space required for the image, you will not be able to install many packages into the container before running out of space.</p>

<p>OpenShift Online, the public hosted version of OpenShift from Red Hat has a quota of only 3GB for the image and container file system. As a result, only the <code class="language-plaintext highlighter-rouge">minimal-notebook</code> can be started and there is little space remaining to install additional packages. Although OpenShift Online is suitable for demonstrating these templates work, what you can do in that environment will be limited due to the size of the images.</p>

<p>If you want to experiment with using Jupyter Notebooks in an OpenShift environment, you should instead use <a href="https://www.openshift.org/minishift/">Minishift</a>. Minishift provides you the ability to run OpenShift in a virtual machine on your own local computer.</p>

<h2 id="loading-the-templates">Loading the Templates</h2>

<p>To load the templates, login to OpenShift from the command line and run:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>oc create <span class="nt">-f</span> https://raw.githubusercontent.com/jupyter-on-openshift/docker-stacks/master/examples/openshift/templates.json
</code></pre></div></div>

<p>This should create the following templates:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>jupyter-notebook
</code></pre></div></div>

<p>The template can be used from the command line using the <code class="language-plaintext highlighter-rouge">oc new-app</code> command, or from the OpenShift web console by selecting <em>Add to Project</em>. This <code class="language-plaintext highlighter-rouge">README</code> is only going to explain deploying from the command line.</p>

<h2 id="deploying-a-notebook">Deploying a Notebook</h2>

<p>To deploy a notebook from the command line using the template, run:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>oc new-app <span class="nt">--template</span> jupyter-notebook
</code></pre></div></div>

<p>The output will be similar to:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>--&gt; Deploying template "jupyter/jupyter-notebook" to project jupyter

     Jupyter Notebook
     ---------
     Template for deploying Jupyter Notebook images.

     * With parameters:
        * APPLICATION_NAME=notebook
        * NOTEBOOK_IMAGE=jupyter/minimal-notebook:latest
        * NOTEBOOK_PASSWORD=ded4d7cada554aa48e0db612e1ed1080 # generated

--&gt; Creating resources ...
    configmap "notebook-cfg" created
    deploymentconfig "notebook" created
    route "notebook" created
    service "notebook" created
--&gt; Success
    Access your application via route 'notebook-jupyter.b9ad.pro-us-east-1.openshiftapps.com'
    Run 'oc status' to view your app.
</code></pre></div></div>

<p>When no template parameters are provided, the name of the deployed notebook will be <code class="language-plaintext highlighter-rouge">notebook</code>. The image used will be:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>jupyter/minimal-notebook:latest
</code></pre></div></div>

<p>A password you can use when accessing the notebook will be auto generated and is displayed in the output from running <code class="language-plaintext highlighter-rouge">oc new-app</code>.</p>

<p>To see the hostname for accessing the notebook run:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>oc get routes
</code></pre></div></div>

<p>The output will be similar to:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>NAME       HOST/PORT                                               PATH      SERVICES   PORT       TERMINATION     WILDCARD
notebook   notebook-jupyter.abcd.pro-us-east-1.openshiftapps.com             notebook   8888-tcp   edge/Redirect   None
</code></pre></div></div>

<p>A secure route will be used to expose the notebook outside of the OpenShift cluster, so in this case the URL would be:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://notebook-jupyter.abcd.pro-us-east-1.openshiftapps.com/
</code></pre></div></div>

<p>When prompted, enter the password for the notebook.</p>

<h2 id="passing-template-parameters">Passing Template Parameters</h2>

<p>To override the name for the notebook, the image used, and the password, you can pass template parameters using the <code class="language-plaintext highlighter-rouge">--param</code> option.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>oc new-app <span class="nt">--template</span> jupyter-notebook <span class="se">\</span>
  <span class="nt">--param</span> <span class="nv">APPLICATION_NAME</span><span class="o">=</span>mynotebook <span class="se">\</span>
  <span class="nt">--param</span> <span class="nv">NOTEBOOK_IMAGE</span><span class="o">=</span>jupyter/scipy-notebook:latest <span class="se">\</span>
  <span class="nt">--param</span> <span class="nv">NOTEBOOK_PASSWORD</span><span class="o">=</span>mypassword
</code></pre></div></div>

<p>You can deploy any of the Jupyter Project docker-stacks images.</p>

<ul>
  <li>jupyter/base-notebook</li>
  <li>jupyter/r-notebook</li>
  <li>jupyter/minimal-notebook</li>
  <li>jupyter/scipy-notebook</li>
  <li>jupyter/tensorflow-notebook</li>
  <li>jupyter/datascience-notebook</li>
  <li>jupyter/pyspark-notebook</li>
  <li>jupyter/all-spark-notebook</li>
</ul>

<p>If you don’t care what version of the image is used, add the <code class="language-plaintext highlighter-rouge">:latest</code> tag at the end of the image name, otherwise use the hash corresponding to the image version you want to use.</p>

<h2 id="deleting-the-notebook-instance">Deleting the Notebook Instance</h2>

<p>To delete the notebook instance, run <code class="language-plaintext highlighter-rouge">oc delete</code> using a label selector for the application name.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>oc delete all,configmap <span class="nt">--selector</span> <span class="nv">app</span><span class="o">=</span>mynotebook
</code></pre></div></div>

<h2 id="enabling-jupyter-lab-interface">Enabling Jupyter Lab Interface</h2>

<p>To enable the Jupyter Lab interface for a deployed notebook set the <code class="language-plaintext highlighter-rouge">JUPYTER_ENABLE_LAB</code> environment variable.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>oc <span class="nb">set env </span>dc/mynotebook <span class="nv">JUPYTER_ENABLE_LAB</span><span class="o">=</span><span class="nb">true</span>
</code></pre></div></div>

<p>Setting the environment variable will trigger a new deployment and the Jupyter Lab interface will be enabled.</p>

<h2 id="adding-persistent-storage">Adding Persistent Storage</h2>

<p>You can upload notebooks and other files using the web interface of the notebook. Any uploaded files or changes you make to them will be lost when the notebook instance is restarted. If you want to save your work, you need to add persistent storage to the notebook. To add persistent storage run:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>oc <span class="nb">set </span>volume dc/mynotebook <span class="nt">--add</span> <span class="se">\</span>
      <span class="nt">--type</span><span class="o">=</span>pvc <span class="nt">--claim-size</span><span class="o">=</span>1Gi <span class="nt">--claim-mode</span><span class="o">=</span>ReadWriteOnce <span class="se">\</span>
      <span class="nt">--claim-name</span> mynotebook-data <span class="nt">--name</span> data <span class="se">\</span>
      <span class="nt">--mount-path</span> /home/jovyan
</code></pre></div></div>

<p>When you have deleted the notebook instance, if using a persistent volume, you will need to delete it in a separate step.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>oc delete pvc/mynotebook-data
</code></pre></div></div>

<h2 id="customizing-the-configuration">Customizing the Configuration</h2>

<p>If you want to set any custom configuration for the notebook, you can edit the config map created by the template.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>oc edit configmap/mynotebook-cfg
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">data</code> field of the config map contains Python code used as the <code class="language-plaintext highlighter-rouge">jupyter_notebook_config.py</code> file.</p>

<p>If you are using a persistent volume, you can also create a configuration file at:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/home/jovyan/.jupyter/jupyter_notebook_config.py
</code></pre></div></div>

<p>This will be merged at the end of the configuration from the config map.</p>

<p>Because the configuration is Python code, ensure any indenting is correct. Any errors in the configuration file will cause the notebook to fail when starting.</p>

<p>If the error is in the config map, edit it again to fix it and trigged a new deployment if necessary by running:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>oc rollout latest dc/mynotebook
</code></pre></div></div>

<p>If you make an error in the configuration file stored in the persistent volume, you will need to scale down the notebook so it isn’t running.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>oc scale dc/mynotebook <span class="nt">--replicas</span> 0
</code></pre></div></div>

<p>Then run:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>oc debug dc/mynotebook
</code></pre></div></div>

<p>to run the notebook in debug mode. This will provide you with an interactive terminal session inside a running container, but the notebook will not have been started. Edit the configuration file in the volume to fix any errors and exit the terminal session.</p>

<p>Start up the notebook again.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>oc scale dc/mynotebook <span class="nt">--replicas</span> 1
</code></pre></div></div>

<h2 id="changing-the-notebook-password">Changing the Notebook Password</h2>

<p>The password for the notebook is supplied as a template parameter, or if not supplied will be automatically generated by the template. It will be passed into the container through an environment variable.</p>

<p>If you want to change the password, you can do so by editing the environment variable on the deployment configuration.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>oc <span class="nb">set env </span>dc/mynotebook <span class="nv">JUPYTER_NOTEBOOK_PASSWORD</span><span class="o">=</span>mypassword
</code></pre></div></div>

<p>This will trigger a new deployment so ensure you have downloaded any work if not using a persistent volume.</p>

<p>If using a persistent volume, you could instead setup a password in the file:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/home/jovyan/.jupyter/jupyter_notebook_config.py
</code></pre></div></div>

<p>as per guidelines in:</p>

<ul>
  <li>https://jupyter-notebook.readthedocs.io/en/stable/public_server.html</li>
</ul>

<h2 id="deploying-from-a-custom-image">Deploying from a Custom Image</h2>

<p>If you want to deploy a custom variant of the Jupyter Project docker-stacks images, you can replace the image name with that of your own. If the image is not stored on Docker Hub, but some other public image registry, prefix the name of the image with the image registry host details.</p>

<p>If the image is in your OpenShift project, because you imported the image into OpenShift, or used the docker build strategy of OpenShift to build a derived custom image, you can use the name of the image stream for the image name, including any image tag if necessary.</p>

<p>This can be illustrated by first importing an image into the OpenShift project.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>oc import-image jupyter/datascience-notebook:latest <span class="nt">--confirm</span>
</code></pre></div></div>

<p>Then deploy it using the name of the image stream created.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>oc new-app <span class="nt">--template</span> jupyter-notebook <span class="se">\</span>
  <span class="nt">--param</span> <span class="nv">APPLICATION_NAME</span><span class="o">=</span>mynotebook <span class="se">\</span>
  <span class="nt">--param</span> <span class="nv">NOTEBOOK_IMAGE</span><span class="o">=</span>datascience-notebook <span class="se">\</span>
  <span class="nt">--param</span> <span class="nv">NOTEBOOK_PASSWORD</span><span class="o">=</span>mypassword
</code></pre></div></div>

<p>Importing an image into OpenShift before deploying it means that when a notebook is started, the image need only be pulled from the internal OpenShift image registry rather than Docker Hub for each deployment. Because the images are so large, this can speed up deployments when the image hasn’t previously been deployed to a node in the OpenShift cluster.</p>

  </div>

</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Scaling Python ML</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Scaling Python ML</li><li><a class="u-email" href="mailto:holden@pigscanfly.ca">holden@pigscanfly.ca</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list">
  <li><a href="https://github.com/scalingpythonml"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">scalingpythonml</span></a></li><li><a href="https://www.twitter.com/holdenkarau"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">holdenkarau</span></a></li><li><a href="https://youtube.com/holdenkarau"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#youtube"></use></svg> <span class="username">holdenkarau</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Blog of my adventures working with different tools for scaling Python ML workloads.</p>
      </div>
    </div>

    <br />

    If you enjoy this work and have some extra $s, consider sponsoring <a href="https://github.com/sponsors/holdenk">my OSS work</a>.

    <!-- Disclamer -->

    This blog does not represent any of my employers, software projects, or foundations I'm a part of.
    I am one of the developers of Apache Spark <a href="https://amzn.to/2O6KYYH">and have some books published on the topic</a> <a href="https://amzn.to/2IA6Yf0">(plus a new Kubeflow book)</a> that may influence my views.
    Some of the links on this blog may generate an affiliate commission. I also earn royalties from my books.
    Generally speaking these do not cover the amount I spend on these adventures, but help defray my hardware, <a href="https://amzn.to/31mIOeK">coffee</a>, and <a href="https://dynamodonut.com/">artisinal doughnut</a> costs.

<!-- License -->
    <a rel="license" href="http://creativecommons.org/licenses/by/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by/4.0/88x31.png" /></a><br />The posts on this blog are licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>. <br />

<!-- Fork me on github -->
<a href="https://github.com/scalingpythonml/scalingpythonml.github.io" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>

  </div>

</footer>
</body>

</html>
