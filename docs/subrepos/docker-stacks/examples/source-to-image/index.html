<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Scaling Python ML | Blog of my adventures working with different tools for scaling Python ML workloads.</title>
<meta name="generator" content="Jekyll v3.9.0" />
<meta property="og:title" content="Scaling Python ML" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Blog of my adventures working with different tools for scaling Python ML workloads." />
<meta property="og:description" content="Blog of my adventures working with different tools for scaling Python ML workloads." />
<meta property="og:site_name" content="Scaling Python ML" />
<script type="application/ld+json">
{"url":"/subrepos/docker-stacks/examples/source-to-image/","description":"Blog of my adventures working with different tools for scaling Python ML workloads.","headline":"Scaling Python ML","@type":"WebPage","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link href="https://unpkg.com/@primer/css/dist/primer.css" rel="stylesheet" />
  <link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="/feed.xml" title="Scaling Python ML" />

  <script>
  function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
  }
  window.onload = wrap_img;
  </script>

</head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Scaling Python ML</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about.html">About</a><a class="page-link" href="/mailinglist.html">Mailinglist</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post">

  <header class="post-header">
    <h1 class="post-title"></h1>
  </header>

  <div class="post-content">
    <p>This example provides scripts for building custom Jupyter Notebook images containing notebooks, data files, and with Python packages required by the notebooks already installed. The scripts provided work with the Source-to-Image tool and you can create the images from the command line on your own computer. Templates are also provided to enable running builds in OpenShift, as well as deploying the resulting image to OpenShift to make it available.</p>

<p>The build scripts, when used with the Source-to-Image tool, provide similar capabilities to <code class="language-plaintext highlighter-rouge">repo2docker</code>. When builds are run under OpenShift with the supplied templates, it provides similar capabilities to <code class="language-plaintext highlighter-rouge">mybinder.org</code>, but where notebook instances are deployed in your existing OpenShift project and JupyterHub is not required.</p>

<p>For separate examples of using JupyterHub with OpenShift, see the project:</p>

<ul>
  <li>https://github.com/jupyter-on-openshift/jupyterhub-quickstart</li>
</ul>

<h2 id="source-to-image-project">Source-to-Image Project</h2>

<p>Source-to-Image (S2I) is an open source project which provides a tool for creating container images. It works by taking a base image, injecting additional source code or files into a running container created from the base image, and running a builder script in the container to process the source code or files to prepare the new image.</p>

<p>Details on the S2I tool, and executable binaries for Linux, macOS and Windows, can be found on GitHub at:</p>

<ul>
  <li>https://github.com/openshift/source-to-image</li>
</ul>

<p>The tool is standalone, and can be used on any system which provides a docker daemon for running containers. To provide an end-to-end capability to build and deploy applications in containers, support for S2I is also integrated into container platforms such as OpenShift.</p>

<h2 id="getting-started-with-s2i">Getting Started with S2I</h2>

<p>As an example of how S2I can be used to create a custom image with a bundled set of notebooks, run:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>s2i build <span class="se">\</span>
  <span class="nt">--scripts-url</span> https://raw.githubusercontent.com/jupyter/docker-stacks/master/examples/source-to-image <span class="se">\</span>
  <span class="nt">--context-dir</span> docs/source/examples/Notebook <span class="se">\</span>
  https://github.com/jupyter/notebook <span class="se">\</span>
  jupyter/minimal-notebook:latest <span class="se">\</span>
  notebook-examples
</code></pre></div></div>

<p>This example command will pull down the Git repository <code class="language-plaintext highlighter-rouge">https://github.com/jupyter/notebook</code> and build the image <code class="language-plaintext highlighter-rouge">notebook-examples</code> using the files contained in the <code class="language-plaintext highlighter-rouge">docs/source/examples/Notebook</code> directory of that Git repository. The base image which the files will be combined with is <code class="language-plaintext highlighter-rouge">jupyter/minimal-notebook:latest</code>, but you can specify any of the Jupyter Project <code class="language-plaintext highlighter-rouge">docker-stacks</code> images as the base image.</p>

<p>The resulting image from running the command can be seen by running <code class="language-plaintext highlighter-rouge">docker images</code>.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>REPOSITORY         TAG     IMAGE ID      CREATED        SIZE
notebook-examples  latest  f5899ed1241d  2 minutes ago  2.59GB
</code></pre></div></div>

<p>You can now run the image.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ docker run --rm -p 8888:8888 notebook-examples
Executing the command: jupyter notebook
[I 01:14:50.532 NotebookApp] Writing notebook server cookie secret to /home/jovyan/.local/share/jupyter/runtime/notebook_cookie_secret
[W 01:14:50.724 NotebookApp] WARNING: The notebook server is listening on all IP addresses and not using encryption. This is not recommended.
[I 01:14:50.747 NotebookApp] JupyterLab beta preview extension loaded from /opt/conda/lib/python3.6/site-packages/jupyterlab
[I 01:14:50.747 NotebookApp] JupyterLab application directory is /opt/conda/share/jupyter/lab
[I 01:14:50.754 NotebookApp] Serving notebooks from local directory: /home/jovyan
[I 01:14:50.754 NotebookApp] 0 active kernels
[I 01:14:50.754 NotebookApp] The Jupyter Notebook is running at:
[I 01:14:50.754 NotebookApp] http://[all ip addresses on your system]:8888/?token=04646d5c5e928da75842cd318d4a3c5aa1f942fc5964323a
[I 01:14:50.754 NotebookApp] Use Control-C to stop this server and shut down all kernels (twice to skip confirmation).
[C 01:14:50.755 NotebookApp]

    Copy/paste this URL into your browser when you connect for the first time,
    to login with a token:
        http://localhost:8888/?token=04646d5c5e928da75842cd318d4a3c5aa1f942fc5964323a
</code></pre></div></div>

<p>Open your browser on the URL displayed, and you will find the notebooks from the Git repository and can work with them.</p>

<h2 id="the-s2i-builder-scripts">The S2I Builder Scripts</h2>

<p>Normally when using S2I, the base image would be S2I enabled and contain the builder scripts needed to prepare the image and define how the application in the image should be run. As the Jupyter Project <code class="language-plaintext highlighter-rouge">docker-stacks</code> images are not S2I enabled (although they could be), in the above example the <code class="language-plaintext highlighter-rouge">--scripts-url</code> option has been used to specify that the example builder scripts contained in this directory of this Git repository should be used.</p>

<p>Using the <code class="language-plaintext highlighter-rouge">--scripts-url</code> option, the builder scripts can be hosted on any HTTP server, or you could also use builder scripts local to your computer file using an appropriate <code class="language-plaintext highlighter-rouge">file://</code> format URI argument to <code class="language-plaintext highlighter-rouge">--scripts-url</code>.</p>

<p>The builder scripts in this directory of this repository are <code class="language-plaintext highlighter-rouge">assemble</code> and <code class="language-plaintext highlighter-rouge">run</code> and are provided as examples of what can be done. You can use the scripts as is, or create your own.</p>

<p>The supplied <code class="language-plaintext highlighter-rouge">assemble</code> script performs a few key steps.</p>

<p>The first steps copy files into the location they need to be when the image is run, from the directory where they are initially placed by the <code class="language-plaintext highlighter-rouge">s2i</code> command.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cp</span> <span class="nt">-Rf</span> /tmp/src/. /home/<span class="nv">$NB_USER</span>

<span class="nb">rm</span> <span class="nt">-rf</span> /tmp/src
</code></pre></div></div>

<p>The next steps are:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="o">[</span> <span class="nt">-f</span> /home/<span class="nv">$NB_USER</span>/environment.yml <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span>conda <span class="nb">env </span>update <span class="nt">--name</span> root <span class="nt">--file</span> /home/<span class="nv">$NB_USER</span>/environment.yml
    conda clean <span class="nt">--all</span> <span class="nt">-f</span> <span class="nt">-y</span>
<span class="k">else
    if</span> <span class="o">[</span> <span class="nt">-f</span> /home/<span class="nv">$NB_USER</span>/requirements.txt <span class="o">]</span><span class="p">;</span> <span class="k">then
        </span>pip <span class="nt">--no-cache-dir</span> <span class="nb">install</span> <span class="nt">-r</span> /home/<span class="nv">$NB_USER</span>/requirements.txt
    <span class="k">fi
fi</span>
</code></pre></div></div>

<p>This determines whether a <code class="language-plaintext highlighter-rouge">environment.yml</code> or <code class="language-plaintext highlighter-rouge">requirements.txt</code> file exists with the files and if so, runs the appropriate package management tool to install any Python packages listed in those files.</p>

<p>This means that so long as a set of notebook files provides one of these files listing what Python packages they need, those packages will be automatically installed into the image so they are available when the image is run.</p>

<p>A final step is:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>fix-permissions <span class="nv">$CONDA_DIR</span>
fix-permissions /home/<span class="nv">$NB_USER</span>
</code></pre></div></div>

<p>This fixes up permissions on any new files created by the build. This is necessary to ensure that when the image is run, you can still install additional files. This is important for when an image is run in <code class="language-plaintext highlighter-rouge">sudo</code> mode, or it is hosted in a more secure container platform such as Kubernetes/OpenShift where it will be run as a set user ID that isn’t known in advance.</p>

<p>As long as you preserve the first and last set of steps, you can do whatever you want in the <code class="language-plaintext highlighter-rouge">assemble</code> script to install packages, create files etc. Do be aware though that S2I builds do not run as <code class="language-plaintext highlighter-rouge">root</code> and so you cannot install additional system packages. If you need to install additional system packages, use a <code class="language-plaintext highlighter-rouge">Dockerfile</code> and normal <code class="language-plaintext highlighter-rouge">docker build</code> to first create a new custom base image from the Jupyter Project <code class="language-plaintext highlighter-rouge">docker-stacks</code> images, with the extra system packages, and then use that image with the S2I build to combine your notebooks and have Python packages installed.</p>

<p>The <code class="language-plaintext highlighter-rouge">run</code> script in this directory is very simple and just runs the notebook application.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">exec </span>start-notebook.sh <span class="s2">"</span><span class="nv">$@</span><span class="s2">"</span>
</code></pre></div></div>

<h2 id="integration-with-openshift">Integration with OpenShift</h2>

<p>The OpenShift platform provides integrated support for S2I type builds. Templates are provided for using the S2I build mechanism with the scripts in this directory. To load the templates run:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>oc create <span class="nt">-f</span> https://raw.githubusercontent.com/jupyter/docker-stacks/master/examples/source-to-image/templates.json
</code></pre></div></div>

<p>This will create the templates:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>jupyter-notebook-builder
jupyter-notebook-quickstart
</code></pre></div></div>

<p>The templates can be used from the OpenShift web console or command line. This <code class="language-plaintext highlighter-rouge">README</code> is only going to explain deploying from the command line.</p>

<p>To use the OpenShift command line to build into an image, and deploy, the set of notebooks used above, run:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>oc new-app <span class="nt">--template</span> jupyter-notebook-quickstart <span class="se">\</span>
  <span class="nt">--param</span> <span class="nv">APPLICATION_NAME</span><span class="o">=</span>notebook-examples <span class="se">\</span>
  <span class="nt">--param</span> <span class="nv">GIT_REPOSITORY_URL</span><span class="o">=</span>https://github.com/jupyter/notebook <span class="se">\</span>
  <span class="nt">--param</span> <span class="nv">CONTEXT_DIR</span><span class="o">=</span>docs/source/examples/Notebook <span class="se">\</span>
  <span class="nt">--param</span> <span class="nv">BUILDER_IMAGE</span><span class="o">=</span>jupyter/minimal-notebook:latest <span class="se">\</span>
  <span class="nt">--param</span> <span class="nv">NOTEBOOK_PASSWORD</span><span class="o">=</span>mypassword
</code></pre></div></div>

<p>You can provide a password using the <code class="language-plaintext highlighter-rouge">NOTEBOOK_PASSWORD</code> parameter. If you don’t set that parameter, a password will be generated, with it being displayed by the <code class="language-plaintext highlighter-rouge">oc new-app</code> command.</p>

<p>Once the image has been built, it will be deployed. To see the hostname for accessing the notebook, run <code class="language-plaintext highlighter-rouge">oc get routes</code>.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>NAME                HOST/PORT                                                       PATH SERVICES           PORT      TERMINATION    WILDCARD
notebook-examples   notebook-examples-jupyter.abcd.pro-us-east-1.openshiftapps.com       notebook-examples  8888-tcp  edge/Redirect  None
</code></pre></div></div>

<p>As the deployment will use a secure connection, the URL for accessing the notebook in this case would be:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>https://notebook-examples-jupyter.abcd.pro-us-east-1.openshiftapps.com
</code></pre></div></div>

<p>If you only want to build an image but not deploy it, you can use the <code class="language-plaintext highlighter-rouge">jupyter-notebook-builder</code> template. You can then deploy it using the <code class="language-plaintext highlighter-rouge">jupyter-notebook</code> template provided with the <a href="../openshift">openshift</a> examples directory.</p>

<p>See the <code class="language-plaintext highlighter-rouge">openshift</code> examples directory for further information on customizing configuration for a Jupyter Notebook deployment and deleting a deployment.</p>

  </div>

</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Scaling Python ML</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Scaling Python ML</li><li><a class="u-email" href="mailto:holden@pigscanfly.ca">holden@pigscanfly.ca</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list">
  <li><a href="https://github.com/scalingpythonml"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">scalingpythonml</span></a></li><li><a href="https://www.twitter.com/holdenkarau"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">holdenkarau</span></a></li><li><a href="https://youtube.com/holdenkarau"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#youtube"></use></svg> <span class="username">holdenkarau</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Blog of my adventures working with different tools for scaling Python ML workloads.</p>
      </div>
    </div>

    <br />

    If you enjoy this work and have some extra $s, consider sponsoring <a href="https://github.com/sponsors/holdenk">my OSS work</a>.

    <!-- Disclamer -->

    This blog does not represent any of my employers, software projects, or foundations I'm a part of.
    I am one of the developers of Apache Spark <a href="https://amzn.to/2O6KYYH">and have some books published on the topic</a> <a href="https://amzn.to/2IA6Yf0">(plus a new Kubeflow book)</a> that may influence my views.
    Some of the links on this blog may generate an affiliate commission. I also earn royalties from my books.
    Generally speaking these do not cover the amount I spend on these adventures, but help defray my hardware, <a href="https://amzn.to/31mIOeK">coffee</a>, and <a href="https://dynamodonut.com/">artisinal doughnut</a> costs.

<!-- License -->
    <a rel="license" href="http://creativecommons.org/licenses/by/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by/4.0/88x31.png" /></a><br />The posts on this blog are licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>. <br />

<!-- Fork me on github -->
<a href="https://github.com/scalingpythonml/scalingpythonml.github.io" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>

  </div>

</footer>
</body>

</html>
