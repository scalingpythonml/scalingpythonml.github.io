<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Deploying Jupyter Lab/Notebook for Dask on ARM on Kubernetes | Scaling Python ML</title>
<meta name="generator" content="Jekyll v3.9.0" />
<meta property="og:title" content="Deploying Jupyter Lab/Notebook for Dask on ARM on Kubernetes" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="In this post, we are going to go through how to deploy Jupyter Lab on ARM on Kubernetes. We&#8217;ll also build a container for use with Dask, but you can skip/customize this step to meet your own needs. In the previous post, I got Dask on ARM on Kubernetes working, while using remote access to allow the Jupyter notebook to run outside of the cluster. After running into a few issues from having the client code outside of the cluster, I decided it was worth the effort to set up Jupyter on ARM on K8s." />
<meta property="og:description" content="In this post, we are going to go through how to deploy Jupyter Lab on ARM on Kubernetes. We&#8217;ll also build a container for use with Dask, but you can skip/customize this step to meet your own needs. In the previous post, I got Dask on ARM on Kubernetes working, while using remote access to allow the Jupyter notebook to run outside of the cluster. After running into a few issues from having the client code outside of the cluster, I decided it was worth the effort to set up Jupyter on ARM on K8s." />
<link rel="canonical" href="https://scalingpythonml.com/2020/12/12/deploying-jupyter-lab-notebook-for-dask-on-arm-on-k8s.html" />
<meta property="og:url" content="https://scalingpythonml.com/2020/12/12/deploying-jupyter-lab-notebook-for-dask-on-arm-on-k8s.html" />
<meta property="og:site_name" content="Scaling Python ML" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2020-12-12T00:00:00-08:00" />
<script type="application/ld+json">
{"@type":"BlogPosting","dateModified":"2020-12-12T00:00:00-08:00","datePublished":"2020-12-12T00:00:00-08:00","headline":"Deploying Jupyter Lab/Notebook for Dask on ARM on Kubernetes","url":"https://scalingpythonml.com/2020/12/12/deploying-jupyter-lab-notebook-for-dask-on-arm-on-k8s.html","mainEntityOfPage":{"@type":"WebPage","@id":"https://scalingpythonml.com/2020/12/12/deploying-jupyter-lab-notebook-for-dask-on-arm-on-k8s.html"},"description":"In this post, we are going to go through how to deploy Jupyter Lab on ARM on Kubernetes. We&#8217;ll also build a container for use with Dask, but you can skip/customize this step to meet your own needs. In the previous post, I got Dask on ARM on Kubernetes working, while using remote access to allow the Jupyter notebook to run outside of the cluster. After running into a few issues from having the client code outside of the cluster, I decided it was worth the effort to set up Jupyter on ARM on K8s.","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<!-- favicon -->
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/site.webmanifest">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="theme-color" content="#ffffff">
  <!-- End favicon -->
  <link href="https://unpkg.com/@primer/css/dist/primer.css" rel="stylesheet" />
  <link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="https://scalingpythonml.com/feed.xml" title="Scaling Python ML" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css" integrity="sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq" crossorigin="anonymous">
    <script type="text/javascript" async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"> </script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js" integrity="sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js" integrity="sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI" crossorigin="anonymous"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function() {
        renderMathInElement( document.body, {
          delimiters: [
            {left: "$$", right: "$$", display: true},
            {left: "[%", right: "%]", display: true},
            {left: "$", right: "$", display: false}
          ]}
        );
      });
    </script>
  

  <script>
  function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
  }
  window.onload = wrap_img;
  </script>

</head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Scaling Python ML</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about.html">About</a><a class="page-link" href="/mailinglist.html">Mailinglist</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Deploying Jupyter Lab/Notebook for Dask on ARM on Kubernetes</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2020-12-12T00:00:00-08:00" itemprop="datePublished">Dec 12, 2020
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>In this post, we are going to go through how to deploy Jupyter Lab on ARM on Kubernetes. We&#8217;ll also build a container for use with Dask, but you can skip/customize this step to meet your own needs. In the <a href="/2020/11/03/a-first-look-at-dask-on-arm-on-k8s.html">previous post, I got Dask on ARM on Kubernetes working</a>, while using remote access to allow the Jupyter notebook to run outside of the cluster. After running into a few issues from having the client code outside of the cluster, I decided it was worth the effort to set up Jupyter on ARM on K8s.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_rebuilding-the-jupyterhub-containers">Rebuilding the JupyterHub Containers</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The default Jupyter containers are not yet cross-built for ARM. If your primary development machine is not an ARM machine, you&#8217;ll want to set up Docker buildx for cross-building, and I&#8217;ve got some instructions on how to do this.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
<div class="paragraph">
<p>One of Jupyter&#8217;s containers uses cgo to build a small bootstrap program: this program will not build under QEMU. If you get an error building your containers check out <a href="/2020/12/11/some-sharp-corners-with-docker-buildx.html">my instructions on cross-building with real hosts.</a> You can also cross-build without QEMU (discussed in the same post).</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>JupyterLab uses a special program called <a href="https://pypi.org/project/chartpress/">ChartPress</a> to build it&#8217;s images. This program&#8217;s compose building capabilities are similar to Docker&#8217;s but are Python focused. To make ChartPress use Docker buildx, you&#8217;ll want to clone the repo <code>git clone <a href="mailto:git@github.com">git@github.com</a>:jupyterhub/chartpress.git</code> and replace the following line in chartpress.py</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight" style="background: #f8f8f8;"><code data-lang="diff"><span></span><span style="color: #A00000">-    cmd = [&#39;docker&#39;, &#39;build&#39;, &#39;-t&#39;, image_spec, context_path]</span>

<span style="color: #00A000">+    cmd = [&#39;docker&#39;, &#39;buildx&#39;, &#39;build&#39;, &#39;-t&#39;, image_spec, context_path, &quot;--platform&quot;, &quot;linux/arm64,linux/amd64&quot;, &quot;--push&quot;]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Then you can pip install your local version:</p>
</div>
<div class="paragraph">
<p>pip install -e .</p>
</div>
<div class="paragraph">
<p>Now that you have ChartPress set up to cross-build for ARM64 and AMD64, you can check out <a href="https://github.com/jupyter/docker-stacks">docker-stacks repo</a> and make a few changes. First is the base notebook container targets a specific non-cross platform hash, so we&#8217;ll change the "FROM":</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight" style="background: #f8f8f8;"><code data-lang="diff"><span></span><span style="color: #A00000">-ARG ROOT_CONTAINER=ubuntu:focal-20200925@sha256:2e70e9c81838224b5311970dbf7ed16802fbfe19e7a70b3cbfa3d7522aa285b4</span>

<span style="color: #00A000">+#ARG ROOT_CONTAINER=ubuntu:focal-20200925@sha256:2e70e9c81838224b5311970dbf7ed16802fbfe19e7a70b3cbfa3d7522aa285b4</span>

<span style="color: #00A000">+ARG ROOT_CONTAINER=ubuntu:focal</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Next, is that Miniconda doesn&#8217;t have full ARM64 support, so you&#8217;ll want to swap the Miniconda install to Miniforge:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight" style="background: #f8f8f8;"><code data-lang="diff"><span></span><span style="color: #A00000">-RUN wget --quiet https://repo.continuum.io/miniconda/Miniconda3-py38_${MINICONDA_VERSION}-Linux-x86_64.sh &amp;&amp; \</span>

<span style="color: #A00000">-    echo &quot;${miniconda_checksum} *Miniconda3-py38_${MINICONDA_VERSION}-Linux-x86_64.sh&quot; | md5sum -c - &amp;&amp; \</span>

<span style="color: #A00000">-    /bin/bash Miniconda3-py38_${MINICONDA_VERSION}-Linux-x86_64.sh -f -b -p $CONDA_DIR &amp;&amp; \</span>

<span style="color: #A00000">-    rm Miniconda3-py38_${MINICONDA_VERSION}-Linux-x86_64.sh &amp;&amp; \</span>

<span style="color: #00A000">+RUN export arch=$(uname -m) &amp;&amp; \</span>

<span style="color: #00A000">+    if [ &quot;$arch&quot; == &quot;aarm64&quot; ]; then \</span>

<span style="color: #00A000">+      arch=&quot;arm64&quot;; \</span>

<span style="color: #00A000">+    fi; \</span>

<span style="color: #00A000">+    wget --quiet https://github.com/conda-forge/miniforge/releases/download/4.8.5-1/Miniforge3-4.8.5-1-Linux-${arch}.sh -O miniforge.sh &amp;&amp; \</span>

<span style="color: #00A000">+    chmod a+x miniforge.sh &amp;&amp; \</span>

<span style="color: #00A000">+    ./miniforge.sh -f -b -p $CONDA_DIR &amp;&amp; \</span>

<span style="color: #00A000">+    rm miniforge.sh &amp;&amp; \</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The docker-stacks notebooks are built with a Makefile so to build the base image, you&#8217;ll execute <code>OWNER=holdenk make build/base-notebook</code>, where you set "OWNER" to your dockerhub username.</p>
</div>
<div class="paragraph">
<p>In addition to the docker-stack images you&#8217;ll want to rebuild the zero-to-jupyterhub-k8s and jconfigurable-http-proxy.</p>
</div>
<div class="paragraph">
<p>With zero-to-jupyter-hub-k8s you&#8217;ll also need to change <code>images/singleuser-sample/Dockerfile</code> to use the docker-stack image you built (e.g. in mine I replaced <code>FROM jupyter/base-notebook:45bfe5a474fa</code> with <code>FROM  holdenk/base-notebook:latest</code>) . The py-spy package will also need to be removed from the images/hub/requirements.txt file since it is not cross-built (and it is optional anyway). zero-to-jupyterhub-k8s is built with <code>chartpress</code>, so you will just build with a custom image prefix as in <a href="#ex_chartpress_build">[ex_chartpress_build]</a>.</p>
</div>
<div id="ex_chartpress_build" class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight" style="background: #f8f8f8;"><code data-lang="bash"><span></span>chartpress  --image-prefix holdenk/jupyter-hub-magic --force-build</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>With jconfigurable-http-proxy no changes are necessary to the project it&#8217;s self, and you can directly run <code>docker buildx build -t holdenk/jconfigurable-http-proxy:0.0.1 .  --platform linux/arm64,linux/amd64 --push</code>. Note this is a different build command as the proxy project does not use chartpress.</p>
</div>
<div class="sect2">
<h3 id="_configuring-the-container-images">Configuring the container images</h3>
<div class="paragraph">
<p>Now that you&#8217;ve built the container images, we need to configure our helm chart to use them. When you run <code>chartpress</code> inside of the zero-to-jupyterhub-k8s repo, it updates the jupyterhub values for the helm chart. You can either use this new chart by following the helm instruction on using a <a href="https://v2.helm.sh/docs/chart_repository/">chart repository</a> or you can use the existing published helm chart and override the images.</p>
</div>
<div class="paragraph">
<p>To install with the existing published chart you can run <a href="#install_existing">[install_existing]</a>.</p>
</div>
<div id="install_existing" class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight" style="background: #f8f8f8;"><code data-lang="bash"><span></span>helm repo add jupyterhub https://jupyterhub.github.io/helm-chart/
helm repo update</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>To override the images, you&#8217;ll need to specify the images in your configuration to helm when your doing your install later as in <a href="#img-config">[img-config]</a>. I put this in a file called <code>config.yaml</code>.</p>
</div>
<div id="img-config" class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight" style="background: #f8f8f8;"><code data-lang="yaml"><span></span>hub:
  image:
    name: holdenk/jupyter-hub-magichub
proxy:
  secretSync:
    image:
      name: holdenk/jupyter-hub-magicsecret-sync
      tag: <span style="color: #BA2121">&#39;0.10.2&#39;</span>
<span style="color: #408080; font-style: italic"># This one needs to be override either way.</span>
  chp:
    image:
      name: holdenk/jconfigurable-http-proxy
      tag: <span style="color: #BA2121">&#39;0.0.1&#39;</span>
singleuser:
  networkTools:
    image:
      name: holdenk/jupyter-hub-magicnetwork-tools
      tag: <span style="color: #BA2121">&#39;0.10.2&#39;</span>
  image:
    name: holdenk/jupyter-hub-magicsingleuser-sample
    tag: <span style="color: #BA2121">&#39;0.10.2&#39;</span>
prePuller:
  hook:
    image:
      name: holdenk/jupyter-hub-magicimage-awaiter
      tag: <span style="color: #BA2121">&#39;0.10.2&#39;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>We&#8217;ll keep building on the above configuration, since we need to do more than just override the images.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_setting-up-a-ssl-certificate">Setting up a SSL Certificate</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Jupyter expects an SSL certificate for its endpoint. If you don&#8217;t have cert manager installed, the guide at <a href="https://opensource.com/article/20/3/ssl-letsencrypt-k3s"><a href="https://opensource.com/article/20/3/ssl-letsencrypt-k3s" class="bare">https://opensource.com/article/20/3/ssl-letsencrypt-k3s</a> shows how to configure SSL using Let&#8217;s Encrypt</a>. If you don&#8217;t have a publicly accessible IP and domain, you&#8217;ll need to use an alternative provider. Once you have cert-manager installed it&#8217;s time to request the certificate. The YAML for my certificate request for`holdenkarau.mooo.com` is shown in <a href="#cert-req">[cert-req]</a>.</p>
</div>
<div id="cert-req" class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight" style="background: #f8f8f8;"><code data-lang="yaml"><span></span>apiVersion: cert-manager.io/v1alpha2
kind: Certificate
metadata:
  name: k3s-mooo
  namespace: jhub
spec:
  secretName: k3s-mooo-tls
  issuerRef:
    name: letsencrypt-prod
    kind: ClusterIssuer
  commonName: holdenkarau.mooo.com
  dnsNames:
  - holdenkarau.mooo.com</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Once you make your certificate request you can apply with <code>kubectl apply -f le-prod-cert.yaml</code>, and monitor it with <code>kubectl get certificates -n jhub -w -o yaml</code>. If your certificate does not become "Ready", you should check out the <a href="https://cert-manager.io/docs/faq/acme/">cert-manager debugging guide</a>.</p>
</div>
<div class="paragraph">
<p>Now that you&#8217;ve got your SSl certificate stored as a secret in your cluster, you&#8217;ll need configure your JupyterHub ingress to use it by adding <a href="#ingres-config">[ingres-config]</a> to your <code>config.yaml</code>.</p>
</div>
<div id="ingress-config" class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight" style="background: #f8f8f8;"><code data-lang="yaml"><span></span>ingress:
  enabled: true
  hosts:
    - holdenkarau.mooo.com
  tls:
   - hosts:
      - holdenkarau.mooo.com
     secretName: k3s-mooo-tls</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_making-jupyter-work-without-a-second-public-ip">Making Jupyter work without a second public IP</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Since my home only has one public IP address, I changed the service type from LodeBalancer to NodePort, since I did not have a spare public IP to assign to Jupyter.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight" style="background: #f8f8f8;"><code data-lang="yaml"><span></span>proxy:
  service:
    type: NodePort
  secretToken: DIFFERENTSECRET</code></pre>
</div>
</div>
<div class="paragraph">
<p>With this change the service deployed successfully and Traefik (installed in K3s by default) was able to route the requests.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_setting-up-authentication">Setting up Authentication</h2>
<div class="sectionbody">
<div class="paragraph">
<p>I was unable to get the JupyterHub GitHub plugin working, but it looks like there is
an <a href="https://github.com/jupyterhub/zero-to-jupyterhub-k8s/issues/1871">outstanding issue to refactor the auth configuration,</a>
so for now I just hard coded what is known as "dummy" authentication. I recommend using a different kind of authentication as soon as the refactoring is complete.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight" style="background: #f8f8f8;"><code data-lang="yaml"><span></span>auth:
  type: dummy
  dummy:
    password: <span style="color: #BA2121">&#39;mypassword&#39;</span>
  whitelist:
    users:
      - user1
      - user2</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_installing-jupyterhub-with-helm">Installing JupyterHub with Helm</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now you can install this with Helm:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight" style="background: #f8f8f8;"><code data-lang="bash"><span></span><span style="color: #19177C">RELEASE</span><span style="color: #666666">=</span>jhub

<span style="color: #19177C">NAMESPACE</span><span style="color: #666666">=</span>jhub

helm install    <span style="color: #19177C">$RELEASE</span> jupyterhub/jupyterhub   --namespace <span style="color: #19177C">$NAMESPACE</span>   --create-namespace   --version<span style="color: #666666">=0</span>.10.2     --values config.yaml</code></pre>
</div>
</div>
<div class="paragraph">
<p>And now you&#8217;re ready to rock and roll with JupyterHub! However, part of the config is still commented out; that&#8217;s because we have not yet built the single user Dask Jupyter Docker container. If you aren&#8217;t using Dask, this can be your stopping point.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_adding-dask-support">Adding Dask Support</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Adding Dask Support involves configuring permissions to make sure the notebook can create executors, building an image to work with your JupyterHub launcher, and adding the image to as a profile to your launcher.</p>
</div>
<div class="sect2">
<h3 id="_permissions">Permissions</h3>
<div class="paragraph">
<p>The default service account used will probably not have the right permissions to launch dask-distributed workers.
To start with create a specification for the what permission your notebook is going to need, I called my <code>setup.yaml</code> (not very creative I know) as in <a href="#ex-perm-yaml">[ex-perm-yaml]</a></p>
</div>
<div id="ex-perm-yaml" class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight" style="background: #f8f8f8;"><code data-lang="yaml"><span></span>kind: Role
apiVersion: rbac.authorization.k8s.io/v1beta1
metadata:
  name: daskKubernetes
  namespace: dask
rules:
- apiGroups:
  - <span style="color: #BA2121">&quot;&quot;</span>  <span style="color: #408080; font-style: italic"># indicates the core API group</span>
  resources:
  - <span style="color: #BA2121">&quot;pods&quot;</span>
  verbs:
  - <span style="color: #BA2121">&quot;get&quot;</span>
  - <span style="color: #BA2121">&quot;list&quot;</span>
  - <span style="color: #BA2121">&quot;watch&quot;</span>
  - <span style="color: #BA2121">&quot;create&quot;</span>
  - <span style="color: #BA2121">&quot;delete&quot;</span>
- apiGroups:
  - <span style="color: #BA2121">&quot;&quot;</span>  <span style="color: #408080; font-style: italic"># indicates the core API group</span>
  resources:
  - <span style="color: #BA2121">&quot;pods/log&quot;</span>
  verbs:
  - <span style="color: #BA2121">&quot;get&quot;</span>
  - <span style="color: #BA2121">&quot;list&quot;</span>
- apiGroups:
  - <span style="color: #BA2121">&quot;&quot;</span> <span style="color: #408080; font-style: italic"># indicates the core API group</span>
  resources:
  - <span style="color: #BA2121">&quot;services&quot;</span>
  verbs:
  - <span style="color: #BA2121">&quot;get&quot;</span>
  - <span style="color: #BA2121">&quot;list&quot;</span>
  - <span style="color: #BA2121">&quot;watch&quot;</span>
  - <span style="color: #BA2121">&quot;create&quot;</span>
  - <span style="color: #BA2121">&quot;delete&quot;</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Now that you&#8217;ve specified the permissions you can go ahead and create the accounts, namespaces, and bindings to wire everything together as in <a href="#ex-setup-namespace">[ex-setup-namespace]</a>.</p>
</div>
<div id="ex-setup-namespace" class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight" style="background: #f8f8f8;"><code data-lang="bash"><span></span>kubectl create namespace dask
kubectl create serviceaccount dask --namespace dask
kubectl apply -f setup.yaml
kubectl create rolebinding dask-sa-binding --namespace dask --role<span style="color: #666666">=</span>daskKubernetes --user<span style="color: #666666">=</span>dask:dask</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_building-container-images">Building container images</h3>
<div class="paragraph">
<p>The <a href="https://github.com/dask/dask-docker">dask-docker</a> project contains a notebook container file; however, it is not designed for use with JupyterHub&#8217;s launcher. The first change needed is commenting out the auto start in <code>notebook/prepare.sh</code>. The other required change is swapping the Dockerfile with your cross-built &#8201;&#8212;&#8201;single-user-sample. I updated mine to also install some helpful libraries as in <a href="#my_dask_nb_dockerfile">[my_dask_nb_dockerfile]</a>:</p>
</div>
<div id="my_dask_nb_dockerfile" class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight" style="background: #f8f8f8;"><code data-lang="dockerfile"><span></span><span style="color: #008000; font-weight: bold">FROM</span><span style="color: #BA2121">  holdenk/jupyter-hub-magicsingleuser-sample:0.10.2</span>

USER root

<span style="color: #008000; font-weight: bold">RUN</span> apt-get update <span style="color: #BB6622; font-weight: bold">\</span>
    <span style="color: #666666">&amp;&amp;</span> apt-get install -yq graphviz git build-essential <span style="color: #BB6622; font-weight: bold">\</span>
    <span style="color: #666666">&amp;&amp;</span> apt-get clean <span style="color: #BB6622; font-weight: bold">\</span>
    <span style="color: #666666">&amp;&amp;</span> rm -rf /var/lib/apt/lists/*

<span style="color: #008000; font-weight: bold">RUN</span> touch /hello_holden

USER <span style="color: #19177C">$NB_USER</span>

<span style="color: #008000; font-weight: bold">RUN</span> conda install -c conda-forge --yes mamba
<span style="color: #008000; font-weight: bold">RUN</span> mamba install --yes <span style="color: #19177C">python</span><span style="color: #666666">==3</span>.8.6
<span style="color: #008000; font-weight: bold">RUN</span> <span style="color: #666666">(</span>mamba install --yes <span style="color: #19177C">aiohttp</span><span style="color: #666666">==3</span>.7.1 <span style="color: #666666">||</span> pip install <span style="color: #19177C">aiohttp</span><span style="color: #666666">==3</span>.7.1 <span style="color: #666666">)</span>
<span style="color: #008000; font-weight: bold">RUN</span> mamba install --yes <span style="color: #BB6622; font-weight: bold">\</span>
    python-blosc <span style="color: #BB6622; font-weight: bold">\</span>
    cytoolz <span style="color: #BB6622; font-weight: bold">\</span>
    <span style="color: #19177C">dask</span><span style="color: #666666">==2</span>.30.0 <span style="color: #BB6622; font-weight: bold">\</span>
    dask-core<span style="color: #666666">==2</span>.30.0 <span style="color: #BB6622; font-weight: bold">\</span>
    lz4 <span style="color: #BB6622; font-weight: bold">\</span>
    <span style="color: #19177C">numpy</span><span style="color: #666666">==1</span>.19.2 <span style="color: #BB6622; font-weight: bold">\</span>
    ipywidgets <span style="color: #BB6622; font-weight: bold">\</span>
    python-graphviz <span style="color: #666666">&amp;&amp;</span> <span style="color: #BB6622; font-weight: bold">\</span>
    mamba install --yes s3fs gcsfs dropboxdrivefs requests dropbox paramiko adlfs pygit2 pyarrow <span style="color: #666666">&amp;&amp;</span> <span style="color: #BB6622; font-weight: bold">\</span>
    mamba install --yes bokeh numba llvmlite
<span style="color: #008000; font-weight: bold">RUN</span> <span style="color: #666666">(</span>mamba install --yes fastparquet <span style="color: #666666">||</span> pip install fastparquet<span style="color: #666666">)</span>
<span style="color: #008000; font-weight: bold">RUN</span> <span style="color: #666666">(</span>mamba install --yes jupyter-server-proxy <span style="color: #666666">||</span> pip install jupyter-server-proxy<span style="color: #666666">)</span>
<span style="color: #008000; font-weight: bold">RUN</span> <span style="color: #666666">(</span>mamba install --yes dask-labextension<span style="color: #666666">==3</span>.0.0 <span style="color: #666666">||</span> pip install dask-labextension<span style="color: #666666">==3</span>.0.0<span style="color: #666666">)</span>
<span style="color: #008000; font-weight: bold">RUN</span> jupyter labextension install @jupyter-widgets/jupyterlab-manager dask-labextension@3.0.0 @jupyterlab/server-proxy <span style="color: #BB6622; font-weight: bold">\</span>
    <span style="color: #666666">&amp;&amp;</span> jupyter serverextension <span style="color: #008000">enable</span> dask-labextension@3.0.0 @jupyterlab/server-proxy <span style="color: #BB6622; font-weight: bold">\</span>
    <span style="color: #666666">&amp;&amp;</span> pip install dask-kubernetes<span style="color: #666666">==0</span>.11.0 <span style="color: #BB6622; font-weight: bold">\</span>
    <span style="color: #666666">&amp;&amp;</span> jupyter lab clean <span style="color: #BB6622; font-weight: bold">\</span>
    <span style="color: #666666">&amp;&amp;</span> jlpm cache clean <span style="color: #BB6622; font-weight: bold">\</span>
    <span style="color: #666666">&amp;&amp;</span> npm cache clean --force <span style="color: #BB6622; font-weight: bold">\</span>
    <span style="color: #666666">&amp;&amp;</span> find /opt/conda/ -type f,l -name <span style="color: #BA2121">&#39;*.a&#39;</span> -delete <span style="color: #BB6622; font-weight: bold">\</span>
    <span style="color: #666666">&amp;&amp;</span> find /opt/conda/ -type f,l -name <span style="color: #BA2121">&#39;*.pyc&#39;</span> -delete <span style="color: #BB6622; font-weight: bold">\</span>
    <span style="color: #666666">&amp;&amp;</span> find /opt/conda/ -type f,l -name <span style="color: #BA2121">&#39;*.js.map&#39;</span> -delete <span style="color: #BB6622; font-weight: bold">\</span>
    <span style="color: #666666">&amp;&amp;</span> find /opt/conda/lib/python*/site-packages/bokeh/server/static -type f,l -name <span style="color: #BA2121">&#39;*.js&#39;</span> -not -name <span style="color: #BA2121">&#39;*.min.js&#39;</span> -delete <span style="color: #666666">||</span> <span style="color: #008000">echo</span> <span style="color: #BA2121">&quot;no bokeh static files to cleanup&quot;</span> <span style="color: #BB6622; font-weight: bold">\</span>
    <span style="color: #666666">&amp;&amp;</span> rm -rf /opt/conda/pkgs

USER root

<span style="color: #408080; font-style: italic"># Create the /opt/app directory, and assert that Jupyter&#39;s NB_UID/NB_GID values</span>
<span style="color: #408080; font-style: italic"># haven&#39;t changed.</span>
<span style="color: #008000; font-weight: bold">RUN</span> mkdir /opt/app <span style="color: #BB6622; font-weight: bold">\</span>
    <span style="color: #666666">&amp;&amp;</span> <span style="color: #008000; font-weight: bold">if</span> <span style="color: #666666">[</span> <span style="color: #BA2121">&quot;</span><span style="color: #19177C">$NB_UID</span><span style="color: #BA2121">&quot;</span> !<span style="color: #666666">=</span> <span style="color: #BA2121">&quot;1000&quot;</span> <span style="color: #666666">]</span> <span style="color: #666666">||</span> <span style="color: #666666">[</span> <span style="color: #BA2121">&quot;</span><span style="color: #19177C">$NB_GID</span><span style="color: #BA2121">&quot;</span> !<span style="color: #666666">=</span> <span style="color: #BA2121">&quot;100&quot;</span> <span style="color: #666666">]</span>; <span style="color: #008000; font-weight: bold">then</span> <span style="color: #BB6622; font-weight: bold">\</span>
    <span style="color: #008000">echo</span> <span style="color: #BA2121">&quot;Jupyter&#39;s NB_UID/NB_GID changed, need to update the Dockerfile&quot;</span>; <span style="color: #BB6622; font-weight: bold">\</span>
    <span style="color: #008000">exit</span> <span style="color: #666666">1</span>; <span style="color: #BB6622; font-weight: bold">\</span>
    <span style="color: #008000; font-weight: bold">fi</span>

<span style="color: #408080; font-style: italic"># Copy over the example as NB_USER. Unfortuantely we can&#39;t use $NB_UID/$NB_GID</span>
<span style="color: #408080; font-style: italic"># in the `--chown` statement, so we need to hardcode these values.</span>
COPY --chown<span style="color: #666666">=1000</span>:100 examples/ /home/<span style="color: #19177C">$NB_USER</span>/examples
COPY prepare.sh /usr/bin/prepare.sh

<span style="color: #008000; font-weight: bold">ENTRYPOINT</span><span style="color: #BA2121"> [&quot;tini&quot;, &quot;--&quot;, &quot;/usr/bin/prepare.sh&quot;]</span></code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>As before you can build this with the standard <code>docker buildx</code> commands.</p>
</div>
</div>
<div class="sect2">
<h3 id="_configuring-your-jupyter">Configuring your Jupyter</h3>
<div class="paragraph">
<p>To enable Dask with Jupyter you&#8217;ll need to update your configuration to both specify the service account and add a profile for for the notebook container you&#8217;ve created. In my situation this looks like:</p>
</div>
<div class="paragraph">
<p>Once your done with your config changes,  you need to update your install with <code>helm upgrade --cleanup-on-fail   --install $RELEASE jupyterhub/jupyterhub   --namespace $NAMESPACE   --create-namespace   --version=0.10.2   --values config.yaml</code></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion">Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>All in all my confiugration file looks something like <a href="#my-total-config">[my-total-config]</a> (except with diffferent secrets). Your config file will look a bit different depending on the choices you made while running through this config.</p>
</div>
<div id="my-total-config" class="exampleblock">
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight" style="background: #f8f8f8;"><code data-lang="yaml"><span></span>hub:
  image:
    name: holdenk/jupyter-hub-magichub
proxy:
  service:
    type: NodePort
  secretToken: DIFFERENTSECRET
  secretSync:
    image:
      name: holdenk/jupyter-hub-magicsecret-sync
      tag: <span style="color: #BA2121">&#39;0.10.2&#39;</span>
  chp:
    image:
      name: holdenk/jconfigurable-http-proxy
      tag: <span style="color: #BA2121">&#39;0.0.1&#39;</span>
ingress:
  enabled: true
  hosts:
    - holdenkarau.mooo.com
  tls:
   - hosts:
      - holdenkarau.mooo.com
     secretName: k3s-mooo-tls
singleuser:
  serviceAccountName: dask
  networkTools:
    image:
      name: holdenk/jupyter-hub-magicnetwork-tools
      tag: <span style="color: #BA2121">&#39;0.10.2&#39;</span>
  image:
    name: holdenk/jupyter-hub-magicsingleuser-sample
    tag: <span style="color: #BA2121">&#39;0.10.2&#39;</span>
  profileList:
    - display_name: <span style="color: #BA2121">&quot;Minimal</span><span style="color: #19177C"> </span><span style="color: #BA2121">environment&quot;</span>
      description: <span style="color: #BA2121">&quot;To</span><span style="color: #19177C"> </span><span style="color: #BA2121">avoid</span><span style="color: #19177C"> </span><span style="color: #BA2121">too</span><span style="color: #19177C"> </span><span style="color: #BA2121">much</span><span style="color: #19177C"> </span><span style="color: #BA2121">bells</span><span style="color: #19177C"> </span><span style="color: #BA2121">and</span><span style="color: #19177C"> </span><span style="color: #BA2121">whistles:</span><span style="color: #19177C"> </span><span style="color: #BA2121">Python.&quot;</span>
      default: true
    - display_name: <span style="color: #BA2121">&quot;Dask</span><span style="color: #19177C"> </span><span style="color: #BA2121">container&quot;</span>
      description: <span style="color: #BA2121">&quot;If</span><span style="color: #19177C"> </span><span style="color: #BA2121">you</span><span style="color: #19177C"> </span><span style="color: #BA2121">want</span><span style="color: #19177C"> </span><span style="color: #BA2121">to</span><span style="color: #19177C"> </span><span style="color: #BA2121">run</span><span style="color: #19177C"> </span><span style="color: #BA2121">dask&quot;</span>
      kubespawner_override:
        image: holdenk/dask-notebook:v0.9.4b
prePuller:
  hook:
    image:
      name: holdenk/jupyter-hub-magicimage-awaiter
      tag: <span style="color: #BA2121">&#39;0.10.2&#39;</span>
<span style="color: #408080; font-style: italic"># Do something better here! It&#39;s being reworked though - https://github.com/jupyterhub/zero-to-jupyterhub-k8s/issues/1871</span>
auth:
  type: dummy
  dummy:
    password: <span style="color: #BA2121">&#39;mypassword&#39;</span>
  whitelist:
    users:
      - user1
      - user2</code></pre>
</div>
</div>
</div>
</div>
<div class="paragraph">
<p>Now you&#8217;re ready to rock-and-role with more stable Dask jobs, that can survive when your notebook goes to sleep or your home internet connection goes out between you and your cluster. The next blog post will explore how this is a bit more involved for building a JupyterHub launcher container for a Spark notebook.</p>
</div>
</div>
</div>
  </div><a class="u-url" href="/2020/12/12/deploying-jupyter-lab-notebook-for-dask-on-arm-on-k8s.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Scaling Python ML</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Scaling Python ML</li><li><a class="u-email" href="mailto:holden@pigscanfly.ca">holden@pigscanfly.ca</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list">
  <li><a href="https://github.com/scalingpythonml"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">scalingpythonml</span></a></li><li><a href="https://www.twitter.com/holdenkarau"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">holdenkarau</span></a></li><li><a href="https://youtube.com/holdenkarau"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#youtube"></use></svg> <span class="username">holdenkarau</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Blog of my adventures working with different tools for scaling Python ML workloads.</p>
      </div>
    </div>

    <br />

    If you enjoy this work and have some extra $s, consider sponsoring <a href="https://github.com/sponsors/holdenk">my OSS work</a>.

    <!-- Disclamer -->

    This blog does not represent any of my employers, software projects, or foundations I'm a part of.
    I am one of the developers of Apache Spark <a href="https://amzn.to/2O6KYYH">and have some books published on the topic</a> <a href="https://amzn.to/2IA6Yf0">(plus a new Kubeflow book)</a> that may influence my views.
    Some of the links on this blog may generate an affiliate commission. I also earn royalties from my books.
    Generally speaking these do not cover the amount I spend on these adventures, but help defray my hardware, <a href="https://amzn.to/31mIOeK">coffee</a>, and <a href="https://dynamodonut.com/">artisinal doughnut</a> costs.

<!-- License -->
    <a rel="license" href="http://creativecommons.org/licenses/by/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by/4.0/88x31.png" /></a><br />The posts on this blog are licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>. <br />

<!-- Fork me on github -->
<a href="https://github.com/scalingpythonml/scalingpythonml.github.io" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>

  </div>

</footer>
</body>

</html>
